generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  fullName        String?  @map("full_name")
  phone           String?
  role            UserRole @default(BUYER)
  profileImageUrl String?  @map("profile_image_url")
  publicId        String?  @map("public_id")
  isDarkMode      Boolean? @default(false)
  notifications   Boolean? @default(true)
  pushToken       String?  @map("push_token")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  listings         Listing[]
  favorites        Favorite[]
  sentMessages     Message[]  @relation("MessageSender")
  receivedMessages Message[]  @relation("MessageReceiver")

  @@map("users")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  listings Listing[]

  @@map("categories")
}

model Listing {
  id          String        @id @default(uuid())
  sellerId    String        @map("seller_id")
  categoryId  String?       @map("category_id")
  title       String
  description String
  price       Decimal       @db.Decimal(10, 2)
  location    String
  latitude    Decimal?      @db.Decimal(10, 8)
  longitude   Decimal?      @db.Decimal(11, 8)
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  seller    User           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category  Category?      @relation(fields: [categoryId], references: [id])
  images    ListingImage[]
  favorites Favorite[]
  messages  Message[]
  views     ListingView[]

  @@map("listings")
}

model ListingImage {
  id        String   @id @default(uuid())
  listingId String   @map("listing_id")
  imageUrl  String   @map("image_url")
  publicId  String?  @map("public_id")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("listing_images")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  listingId String   @map("listing_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@map("favorites")
}

model Message {
  id         String    @id @default(uuid())
  listingId  String    @map("listing_id")
  senderId   String    @map("sender_id")
  receiverId String    @map("receiver_id")
  content    String
  readAt     DateTime? @map("read_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  listing  Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  sender   User    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User    @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model ListingView {
  id        String   @id @default(uuid())
  listingId String   @map("listing_id")
  viewerId  String?  @map("viewer_id")
  ip        String?  @map("ip")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("listing_views")
}

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum ListingStatus {
  ACTIVE
  SOLD
  INACTIVE
}

enum NotificationType {
  MESSAGE_RECEIVED
  LISTING_VIEWED
  FAVORITE_ADDED
  LISTING_SOLD
  SYSTEM_UPDATE
}
